# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

pr: none

jobs:
- job: BuildApp
  displayName: Build App
  pool:
    vmImage: 'Ubuntu 16.04'
  steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '10.12.x'
  - script: |
      yarn
      yarn tools:prepare-lib
      yarn ng build alyle-ui --aot --output-path dist/alyle-ui-aot
      yarn build
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: 'dist/alyle-ui'
      artifactName: Alyle UI App
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: 'ci/scripts'
      artifactName: Scripts

- job: Test
  displayName: Test
  pool:
    vmImage: ubuntu-latest
  steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '10.12.x'
    - script: |
        curl -o- -L https://yarnpkg.com/install.sh | bash
      displayName: "Install Yarn"
    - script: |
        set -e
        export PATH="$HOME/.yarn/bin:$HOME/.config/yarn/global/node_modules/.bin:$PATH"
        node -v
        yarn -v
      displayName: "Print versions"
    - bash: |
        yarn
        yarn global add tap-xunit
    - script: |
        echo set PATH
        export PATH="$HOME/.yarn/bin:$HOME/.config/yarn/global/node_modules/.bin:$PATH"
        echo adding permissions
        chmod +x ./ci/scripts/publish-tests.sh
        echo run script
        ./ci/scripts/publish-tests.sh
    - bash: |
        chmod +x ./ci/scripts/test.sh
        ./ci/scripts/test.sh
    - task: PublishTestResults@2
      condition: succeededOrFailed()
      inputs:
        testRunner: xUnit
        testResultsFiles: 'dist/test-results.xml'

- job: BuildDocsAndArtifacts
  displayName: Build docs & artifacts
  pool:
    vmImage: 'Ubuntu 16.04'
  steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '10.12.x'
  - bash: |
      chmod +x ./ci/scripts/build-docs-artifacts.sh
      ./ci/scripts/build-docs-artifacts.sh
    displayName: build:@alyle/ui
  - script: |
      yarn tools:docs
    displayName: Build docs-content
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: 'dist/docs-content'
      artifactName: Docs
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: 'dist/@alyle/ui'
      artifactName: alyle-ui-pkg